<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ì‡¼í•‘ ìµœì €ê°€ ë¹„êµ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>ğŸ›ï¸ ë„¤ì´ë²„ ì‡¼í•‘ ìµœì €ê°€ ë¹„êµ</h1>
                    <p>ìƒí’ˆì„ ê²€ìƒ‰í•˜ì—¬ ìµœì €ê°€ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
                </div>
                <div class="header-contact">
                    <a href="mailto:nansadancer@naver.com" class="contact-link">
                        <span class="contact-icon">âœ‰ï¸</span>
                        <span class="contact-text">ë¬¸ì˜í•˜ê¸°</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- ê²€ìƒ‰ ì˜ì—­ -->
        <section class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="ê²€ìƒ‰í•  ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ìƒí’ˆëª…ê³¼ ëª¨ë¸ëª…ê¹Œì§€ ë„£ì–´ì£¼ì„¸ìš”)"
                    autocomplete="off"
                >
                <button id="searchBtn" class="search-btn">ê²€ìƒ‰</button>
            </div>
            <div class="search-options">
                <label>í‘œì‹œí•  ìƒí’ˆ ìˆ˜:</label>
                <select id="displayCount">
                    <option value="5">5ê°œ</option>
                    <option value="10" selected>10ê°œ</option>
                    <option value="20">20ê°œ</option>
                </select>
            </div>
        </section>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- ìµœì €ê°€ ì¹´ë“œ -->
        <section id="lowestPriceSection" class="lowest-price-section" style="display: none;">
            <h2>ğŸ† ìµœì €ê°€ ìƒí’ˆ</h2>
            <div id="lowestPriceCard" class="price-card lowest-card">
                <img id="lowestImage" src="" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="card-image">
                <div class="card-content">
                    <h3 id="lowestTitle"></h3>
                    <div class="price-info">
                        <span class="lowest-label">ìµœì €ê°€</span>
                        <span id="lowestPrice" class="price"></span>
                    </div>
                    <a id="lowestLink" href="" target="_blank" class="card-link">ì‡¼í•‘ëª° ë°”ë¡œê°€ê¸°</a>
                </div>
            </div>
        </section>

        <!-- ê°€ê²© ë²”ìœ„ ì •ë³´ -->
        <section id="priceRangeSection" class="price-range-section" style="display: none;">
            <div class="price-range-box">
                <div class="range-item">
                    <span class="range-label">ìµœì €ê°€:</span>
                    <span id="minPrice" class="range-value"></span>
                </div>
                <div class="range-item">
                    <span class="range-label">ìµœê³ ê°€:</span>
                    <span id="maxPrice" class="range-value"></span>
                </div>
            </div>
        </section>

        <!-- ê´€ë ¨ ìƒí’ˆ ëª©ë¡ -->
        <section id="itemsSection" class="items-section" style="display: none;">
            <h2>ğŸ“¦ ê´€ë ¨ ìƒí’ˆ ëª©ë¡</h2>
            <div id="itemsList" class="items-grid"></div>
        </section>

        <!-- ê²€ìƒ‰ í†µê³„ -->
        <section id="statsSection" class="stats-section" style="display: none;">
            <p id="statsText"></p>
        </section>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const displayCount = document.getElementById('displayCount');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const lowestPriceSection = document.getElementById('lowestPriceSection');
        const itemsSection = document.getElementById('itemsSection');
        const priceRangeSection = document.getElementById('priceRangeSection');
        const statsSection = document.getElementById('statsSection');

        // Enter í‚¤ë¡œ ê²€ìƒ‰
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
        searchBtn.addEventListener('click', performSearch);

        async function performSearch() {
            const query = searchInput.value.trim();
            const display = displayCount.value;

            if (!query) {
                showError('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            // UI ì´ˆê¸°í™”
            hideAllSections();
            showLoading();
            clearError();

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        display: parseInt(display)
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    showError(data.error || 'ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    return;
                }

                // ìµœì €ê°€ ì¹´ë“œ í‘œì‹œ
                displayLowestPrice(data.lowestPrice);

                // ê°€ê²© ë²”ìœ„ í‘œì‹œ
                displayPriceRange(data.priceRange);

                // ìƒí’ˆ ëª©ë¡ í‘œì‹œ
                displayItems(data.items);

                // í†µê³„ í‘œì‹œ
                displayStats(data.query, data.items.length, data.total);

            } catch (error) {
                showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayLowestPrice(item) {
            if (!item) return;

            document.getElementById('lowestImage').src = item.image || 'https://via.placeholder.com/200';
            document.getElementById('lowestTitle').textContent = stripHtml(item.title);
            document.getElementById('lowestPrice').textContent = formatPrice(item.lprice);
            document.getElementById('lowestLink').href = item.link;

            lowestPriceSection.style.display = 'block';
        }

        function displayPriceRange(priceRange) {
            document.getElementById('minPrice').textContent = formatPrice(priceRange.min);
            document.getElementById('maxPrice').textContent = formatPrice(priceRange.max);
            priceRangeSection.style.display = 'block';
        }

        function displayItems(items) {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'item-card';
                if (index === 0) card.classList.add('highlight'); // ì²« ë²ˆì§¸ ìƒí’ˆ ê°•ì¡°

                card.innerHTML = `
                    <img src="${item.image || 'https://via.placeholder.com/150'}" alt="${stripHtml(item.title)}" class="item-image">
                    <div class="item-info">
                        <h4 class="item-title">${stripHtml(item.title)}</h4>
                        <p class="item-brand">${item.brand || 'ë¸Œëœë“œ ë¯¸ì •ë³´'}</p>
                        <p class="item-mall">${item.mallName || 'ì‡¼í•‘ëª° ë¯¸ì •ë³´'}</p>
                        <div class="item-price">
                            <span class="item-price-value">${formatPrice(item.lprice)}</span>
                        </div>
                        <a href="${item.link}" target="_blank" class="item-link">ìƒì„¸ë³´ê¸°</a>
                    </div>
                `;

                itemsList.appendChild(card);
            });

            itemsSection.style.display = 'block';
        }

        function displayStats(query, count, total) {
            const statsText = document.getElementById('statsText');
            statsText.textContent = `"${query}"ì— ëŒ€í•´ ì´ ${total.toLocaleString()}ê°œì˜ ìƒí’ˆ ì¤‘ ${count}ê°œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤`;
            statsSection.style.display = 'block';
        }

        function formatPrice(price) {
            return `â‚©${Number(price).toLocaleString()}`;
        }

        function stripHtml(text) {
            const div = document.createElement('div');
            div.innerHTML = text;
            return div.textContent || div.innerText || '';
        }

        function showLoading() {
            loadingSpinner.style.display = 'flex';
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function clearError() {
            errorMessage.style.display = 'none';
        }

        function hideAllSections() {
            lowestPriceSection.style.display = 'none';
            itemsSection.style.display = 'none';
            priceRangeSection.style.display = 'none';
            statsSection.style.display = 'none';
        }
    </script>
</body>
</html>
